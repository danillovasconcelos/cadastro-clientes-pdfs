<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Serviços — Usuário</title>

  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
  <style>
    body { --pico-font-size: 16px; }
    .muted { opacity: .7 }
    .badge { padding: .2rem .5rem; border-radius: .4rem; font-size: .8rem; }
    .ok{ background:#0ea; color:#012; }
    .warn{ background:#ffc107; color:#222; }
    .err{ background:#f66; color:#fff; }
    .grid{ display:grid; gap:1rem; }
    .grid-2{ grid-template-columns: 1fr 1fr; }
    .grid-3{ grid-template-columns: repeat(3,1fr); }
    .table-wrap{ overflow:auto; }
    .lock { opacity:.5; pointer-events:none; filter:grayscale(1); }
    input[type=file]{ padding:.4rem; }
    .small { font-size:.85rem }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <main class="container">
    <nav>
      <ul>
        <li><a href="./index.html">← Voltar</a></li>
      </ul>
      <ul>
        <li class="muted small">Se necessário, passe pela tela inicial para gravar <code>SUPABASE_URL</code> e <code>ANON_KEY</code> no navegador.</li>
        <li><a href="./analyst.html">Ir ao Painel do Analista</a></li>
      </ul>
    </nav>

    <hgroup>
      <h1>Serviços (Usuário)</h1>
      <p class="muted">Crie o rascunho, envie os PDFs obrigatórios e finalize para análise.</p>
    </hgroup>

    <article id="alertConn" class="err" style="display:none; padding:.8rem; border-radius:.5rem;">
      Configure <strong>SUPABASE_URL</strong> e <strong>ANON_KEY</strong> na tela inicial.
    </article>

    <article id="cardForm">
      <h3>Novo serviço</h3>
      <div class="grid grid-3">
        <label>Tipo de serviço
          <select id="selType"></select>
        </label>
        <label>Proprietário
          <input id="ownerName" placeholder="Nome completo" />
        </label>
        <label>CPF
          <input id="ownerCpf" placeholder="CPF" />
        </label>
      </div>

      <div class="grid grid-2">
        <label>Endereço do proprietário
          <input id="ownerAddr" placeholder="Endereço" />
        </label>
        <label>Endereço da obra
          <input id="siteAddr" placeholder="Endereço" />
        </label>
      </div>

      <div class="grid grid-3">
        <label>Área (m²)
          <input id="areaM2" type="number" min="0" value="0" />
        </label>
        <label>Protocolo
          <input id="proto" class="mono" placeholder="—" disabled />
        </label>
        <label>Status
          <input id="statusTxt" class="mono" placeholder="—" disabled />
        </label>
      </div>

      <footer>
        <button id="btnDraft">Criar rascunho</button>
        <button id="btnSave" class="secondary" disabled>Salvar alterações</button>
      </footer>
    </article>

    <article id="cardDocs" style="display:none;">
      <h3>Documentos obrigatórios</h3>
      <p class="muted small">Selecione o tipo e crie/salva o rascunho para liberar os uploads.</p>
      <div id="docsList" class="grid"></div>

      <footer>
        <button id="btnSendDocs" class="secondary">Enviar documentos</button>
        <button id="btnSubmit" class="contrast">Confirmar e Enviar</button>
      </footer>
    </article>

    <article>
      <h3>Meus serviços</h3>
      <div class="table-wrap">
        <table id="tblServices">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>Protocolo</th>
              <th>Criado em</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </article>
  </main>

  <script>
    /*********************************
     * SUPABASE — Inicialização
     *********************************/
    const SUPA_URL  = sessionStorage.getItem('SUPA_URL')  || localStorage.getItem('SUPABASE_URL');
    const SUPA_KEY  = sessionStorage.getItem('SUPA_KEY')  || localStorage.getItem('SUPABASE_ANON_KEY');
    const CURRENT_COMPANY_ID = sessionStorage.getItem('COMPANY_ID') || localStorage.getItem('COMPANY_ID');

    if (!SUPA_URL || !SUPA_KEY) {
      document.getElementById('alertConn').style.display = 'block';
    }

    const sb = (SUPA_URL && SUPA_KEY) ? window.supabase.createClient(SUPA_URL, SUPA_KEY) : null;

    /*********************************
     * Helpers
     *********************************/
    const $ = sel => document.querySelector(sel);
    const fmt = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

    function toast(msg, type='info') {
      const c = document.createElement('div');
      c.textContent = msg;
      c.style.cssText = `position:fixed; right:1rem; bottom:1rem; padding:.6rem .8rem; border-radius:.5rem; color:#fff; z-index:9999;`;
      c.style.background = type==='err' ? '#d33' : (type==='ok' ? '#0a7' : '#333');
      document.body.appendChild(c);
      setTimeout(()=>c.remove(), 3600);
    }

    /*********************************
     * Inicialização
     *********************************/
    (async function init(){
      if (!sb) return toast('Configuração Supabase ausente', 'err');

      if (!CURRENT_COMPANY_ID) {
        toast('Empresa não definida. Selecione na tela inicial.', 'err');
      }

      // Carregar tipos de serviço
      const { data: types, error } = await sb.from('service_types').select('id, name').order('name');
      if (error) {
        console.error(error);
        toast('Erro ao carregar tipos de serviço', 'err');
      } else {
        const sel = $('#selType');
        sel.innerHTML = '<option value="">Selecione...</option>' +
          types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      }

      // Carregar serviços
      await loadMyServices();
    })();

    /*********************************
     * Demais funções originais mantidas
     *********************************/
    // (a partir daqui mantenha exatamente o mesmo código que você já tinha: btnDraft, btnSave, loadMyServices, etc.)
  </script>
</body>
</html>
